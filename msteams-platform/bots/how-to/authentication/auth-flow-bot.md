---
title: Microsoft Teams Fluxo de autenticação para bots
description: Descreve Microsoft Teams fluxo de autenticação em bots
keywords: bots de fluxo de autenticação do teams
localization_priority: Normal
ms.topic: overview
ms.openlocfilehash: 68ba2024d0e0f2f92a52e93614e4576dcde8dcbc
ms.sourcegitcommit: 14409950307b135265c8582408be5277b35131dd
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 06/17/2021
ms.locfileid: "52994221"
---
# <a name="authentication-flow-for-bots-in-microsoft-teams"></a><span data-ttu-id="fc362-104">Fluxo de autenticação para bots Microsoft Teams</span><span class="sxs-lookup"><span data-stu-id="fc362-104">Authentication flow for bots in Microsoft Teams</span></span>

<span data-ttu-id="fc362-105">O OAuth 2.0 é um padrão aberto para autenticação e autorização usadas pelo Azure Active Directory (Azure AD) e muitos outros provedores de identidade.</span><span class="sxs-lookup"><span data-stu-id="fc362-105">OAuth 2.0 is an open standard for authentication and authorization used by Azure Active Directory (Azure AD) and many other identity providers.</span></span> <span data-ttu-id="fc362-106">Uma compreensão básica do OAuth 2.0 é um pré-requisito para trabalhar com autenticação no Teams; [aqui está uma boa visão geral](https://aaronparecki.com/oauth-2-simplified/) que é mais fácil de seguir do que a [especificação formal](https://oauth.net/2/).</span><span class="sxs-lookup"><span data-stu-id="fc362-106">A basic understanding of OAuth 2.0 is a prerequisite for working with authentication in Teams; [here's a good overview](https://aaronparecki.com/oauth-2-simplified/) that's easier to follow than the [formal specification](https://oauth.net/2/).</span></span> <span data-ttu-id="fc362-107">O fluxo de autenticação para guias e bots é um pouco diferente — as guias são muito semelhantes aos sites, para que eles possam usar o OAuth 2.0 diretamente, enquanto os bots não são e devem fazer algumas coisas de forma diferente — mas os conceitos principais são idênticos.</span><span class="sxs-lookup"><span data-stu-id="fc362-107">Authentication flow for tabs and bots is a little different — tabs are very similar to websites so they can use OAuth 2.0 directly, while bots aren't and must do a few things differently — but the core concepts are identical.</span></span>

<span data-ttu-id="fc362-108">Consulte o GitHub de Microsoft Teams [de](https://github.com/OfficeDev/Microsoft-Teams-Samples/tree/main/samples/app-auth/nodejs) autenticação para um exemplo que demonstra o fluxo de autenticação para bots usando o Node.js e o tipo de concessão de código de autorização [OAuth 2.0](https://oauth.net/2/grant-types/authorization-code/).</span><span class="sxs-lookup"><span data-stu-id="fc362-108">See the GitHub repo [Microsoft Teams Authentication Sample](https://github.com/OfficeDev/Microsoft-Teams-Samples/tree/main/samples/app-auth/nodejs) for an example that demonstrates authentication flow for bots using Node.js and the [OAuth 2.0 authorization code grant type](https://oauth.net/2/grant-types/authorization-code/).</span></span>

![Diagrama de sequência de autenticação bot](../../../assets/images/authentication/bot_auth_sequence_diagram.png)

1. <span data-ttu-id="fc362-110">O usuário envia uma mensagem para o bot.</span><span class="sxs-lookup"><span data-stu-id="fc362-110">The user sends a message to the bot.</span></span>
2. <span data-ttu-id="fc362-111">O bot determina se o usuário precisa entrar.</span><span class="sxs-lookup"><span data-stu-id="fc362-111">The bot determines if the user needs to sign in.</span></span>
   <span data-ttu-id="fc362-112">Neste exemplo, o bot armazena o token de acesso em seu armazenamento de dados do usuário.</span><span class="sxs-lookup"><span data-stu-id="fc362-112">In this example, the bot stores the access token in its user data store.</span></span> <span data-ttu-id="fc362-113">Ele solicita que o usuário entre se não tiver um token validado para o provedor de identidade selecionado.</span><span class="sxs-lookup"><span data-stu-id="fc362-113">It asks the user to sign in if it doesn't have a validated token for the selected identity provider.</span></span> <span data-ttu-id="fc362-114">([Código de exibição](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76))</span><span class="sxs-lookup"><span data-stu-id="fc362-114">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76))</span></span>
3. <span data-ttu-id="fc362-115">O bot constrói a URL para a página inicial do fluxo de autenticação e envia um cartão para o usuário com uma `signin` ação.</span><span class="sxs-lookup"><span data-stu-id="fc362-115">The bot constructs the URL to the start page of the authentication flow, and sends a card to the user with a `signin` action.</span></span> <span data-ttu-id="fc362-116">([Código de exibição](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190))</span><span class="sxs-lookup"><span data-stu-id="fc362-116">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190))</span></span></br>
    <span data-ttu-id="fc362-117">Como outros fluxos de auth de aplicativos no Teams, a página inicial deve estar em um domínio que está em sua lista e no mesmo domínio que a página de redirecionamento `validDomains` pós-logon.</span><span class="sxs-lookup"><span data-stu-id="fc362-117">Like other application auth flows in Teams, the start page must be in a domain that's on your `validDomains` list, and in the same domain as the post-login redirect page.</span></span>
    > [!IMPORTANT] 
    > <span data-ttu-id="fc362-118">O código de autorização OAuth 2.0 concede chamadas de fluxo para um parâmetro na solicitação de autenticação que contém um token de sessão exclusivo para evitar um ataque de falsificação de solicitação entre `state` [sites.](https://en.wikipedia.org/wiki/Cross-site_request_forgery)</span><span class="sxs-lookup"><span data-stu-id="fc362-118">The OAuth 2.0 authorization code grant flow calls for a `state` parameter in the authentication request which contains a unique session token to prevent a [cross-site request forgery attack](https://en.wikipedia.org/wiki/Cross-site_request_forgery).</span></span> <span data-ttu-id="fc362-119">O exemplo usa um GUID gerado aleatoriamente.</span><span class="sxs-lookup"><span data-stu-id="fc362-119">The example uses a randomly-generated GUID.</span></span>
4. <span data-ttu-id="fc362-120">Quando o usuário seleciona o botão *de* Teams abre uma janela pop-up e navega até a página inicial.</span><span class="sxs-lookup"><span data-stu-id="fc362-120">When the user selects the *signin* button, Teams opens a popup window and navigates to the start page.</span></span>
   > [!NOTE]
   > <span data-ttu-id="fc362-121">O tamanho da janela pop-up pode ser controlado por meio de parâmetros de cadeia de caracteres de consulta de largura e altura na URL.</span><span class="sxs-lookup"><span data-stu-id="fc362-121">The size of the pop-up window can be controlled through width and height query string parameters in the URL.</span></span> <span data-ttu-id="fc362-122">Por exemplo, se você adicionar width=600 e height=600, o tamanho da janela pop-up será 600x600 pixels.</span><span class="sxs-lookup"><span data-stu-id="fc362-122">For example, if you add width=600 and height=600, the size of the pop-up window is 600x600 pixels.</span></span> <span data-ttu-id="fc362-123">O tamanho real da janela pop-up é limitado como uma porcentagem do tamanho da janela Teams principal.</span><span class="sxs-lookup"><span data-stu-id="fc362-123">The actual size of the pop-up window is capped as a percentage of the Teams main window size.</span></span> <span data-ttu-id="fc362-124">Se a Teams for pequena, a janela pop-up será menor do que as dimensões especificadas.</span><span class="sxs-lookup"><span data-stu-id="fc362-124">If the Teams window is small, the pop-up window is smaller than the specified dimensions.</span></span>

5. <span data-ttu-id="fc362-125">A página inicial redireciona o usuário para o ponto de extremidade do provedor `authorize` de identidade.</span><span class="sxs-lookup"><span data-stu-id="fc362-125">The start page redirects the user to the identity provider's `authorize` endpoint.</span></span> <span data-ttu-id="fc362-126">([Código de exibição](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56))</span><span class="sxs-lookup"><span data-stu-id="fc362-126">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56))</span></span>
6. <span data-ttu-id="fc362-127">No site do provedor, o usuário faz o acesso e concede acesso ao bot.</span><span class="sxs-lookup"><span data-stu-id="fc362-127">On the provider's site, the user signs in and grants access to the bot.</span></span>
7. <span data-ttu-id="fc362-128">O provedor leva o usuário para a página de redirecionamento OAuth do bot com um código de autorização.</span><span class="sxs-lookup"><span data-stu-id="fc362-128">The provider takes the user to the bot's OAuth redirect page with an authorization code.</span></span>
8. <span data-ttu-id="fc362-129">O bot resgata o código de autorização de um token de acesso e associa provisoriamente o token ao usuário que iniciou o fluxo de entrada. </span><span class="sxs-lookup"><span data-stu-id="fc362-129">The bot redeems the authorization code for an access token, and **provisionally** associates the token with the user that initiated the sign-in flow.</span></span> <span data-ttu-id="fc362-130">Abaixo, chamamos isso de *token provisório*.</span><span class="sxs-lookup"><span data-stu-id="fc362-130">Below, we call this a *provisional token*.</span></span>
    * <span data-ttu-id="fc362-131">No exemplo, o bot associa o valor do parâmetro com a ID do usuário que iniciou o processo de login para que ele possa, posteriormente, corresponder a ele com o valor retornado pelo provedor de `state` `state` identidade.</span><span class="sxs-lookup"><span data-stu-id="fc362-131">In the example, the bot associates the value of the `state` parameter with the ID of the user that initiated the sign-in process so it can later match it with the `state` value returned by the identity provider.</span></span> <span data-ttu-id="fc362-132">([Código de exibição](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99))</span><span class="sxs-lookup"><span data-stu-id="fc362-132">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99))</span></span>
      > [!IMPORTANT] 
      > <span data-ttu-id="fc362-133">O bot armazena o token que recebe do provedor de identidade e o associa a um usuário específico, mas é marcado como "validação pendente".</span><span class="sxs-lookup"><span data-stu-id="fc362-133">The bot stores the token it receives from the identity provider and associates it with a specific user, but it is marked as "pending validation".</span></span> 
    * <span data-ttu-id="fc362-134">O token provisório não pode ser usado sem validação posterior.</span><span class="sxs-lookup"><span data-stu-id="fc362-134">The provisional token can't be used without further validation.</span></span>
      1. <span data-ttu-id="fc362-135">**Valide o que é recebido do provedor de identidade.**</span><span class="sxs-lookup"><span data-stu-id="fc362-135">**Validate what's received from the identity provider.**</span></span> <span data-ttu-id="fc362-136">O valor do `state` parâmetro deve ser confirmado em relação ao que foi salvo anteriormente.</span><span class="sxs-lookup"><span data-stu-id="fc362-136">The value of the `state` parameter must be confirmed against what was saved earlier.</span></span> 
      1. <span data-ttu-id="fc362-137">**Valide o que é recebido do Teams.**</span><span class="sxs-lookup"><span data-stu-id="fc362-137">**Validate what's received from Teams.**</span></span> <span data-ttu-id="fc362-138">Uma [validação de autenticação](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) em duas etapas é realizada para garantir que o usuário que autorizou o bot com o provedor de identidade seja o mesmo usuário que está conversando com o bot.</span><span class="sxs-lookup"><span data-stu-id="fc362-138">A [two-step authentication](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) validation is performed to ensure that the user who authorized the bot with the identity provider is the same user who is chatting with the bot.</span></span> <span data-ttu-id="fc362-139">Isso protege contra ataques de [phishing e](https://en.wikipedia.org/wiki/Phishing) [man-in-the-middle.](https://en.wikipedia.org/wiki/Man-in-the-middle_attack)</span><span class="sxs-lookup"><span data-stu-id="fc362-139">This guards against [man-in-the-middle](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) and [phishing](https://en.wikipedia.org/wiki/Phishing) attacks.</span></span> <span data-ttu-id="fc362-140">O bot gera um código de verificação e o armazena, associado ao usuário.</span><span class="sxs-lookup"><span data-stu-id="fc362-140">The bot generates a verification code and stores it, associated with the user.</span></span> <span data-ttu-id="fc362-141">O código de verificação é enviado automaticamente Teams conforme descrito abaixo.</span><span class="sxs-lookup"><span data-stu-id="fc362-141">The verification code is sent automatically by Teams as described below.</span></span> <span data-ttu-id="fc362-142">([Código de exibição](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113))</span><span class="sxs-lookup"><span data-stu-id="fc362-142">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113))</span></span>
9. <span data-ttu-id="fc362-143">O retorno de chamada OAuth renderiza uma página que chama `notifySuccess("<verification code>")` .</span><span class="sxs-lookup"><span data-stu-id="fc362-143">The OAuth callback renders a page that calls `notifySuccess("<verification code>")`.</span></span> <span data-ttu-id="fc362-144">([Código de exibição](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs))</span><span class="sxs-lookup"><span data-stu-id="fc362-144">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs))</span></span>
10. <span data-ttu-id="fc362-145">Teams fecha a janela pop-up e envia `<verification code>` o enviado de volta para o `notifySuccess()` bot.</span><span class="sxs-lookup"><span data-stu-id="fc362-145">Teams closes the pop-up window and sends the `<verification code>` sent to `notifySuccess()` back to the bot.</span></span> <span data-ttu-id="fc362-146">O bot recebe uma [mensagem de invocação](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) com `name = signin/verifyState` .</span><span class="sxs-lookup"><span data-stu-id="fc362-146">The bot receives an [invoke](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) message with `name = signin/verifyState`.</span></span>
11. <span data-ttu-id="fc362-147">O bot verifica o código de verificação de entrada em relação ao código de verificação armazenado com o token provisório do usuário.</span><span class="sxs-lookup"><span data-stu-id="fc362-147">The bot checks the incoming verification code against the verification code stored with the user's provisional token.</span></span> <span data-ttu-id="fc362-148">([Código de exibição](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140))</span><span class="sxs-lookup"><span data-stu-id="fc362-148">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140))</span></span>
12. <span data-ttu-id="fc362-149">Se eles corresponderem, o bot marcará o token como validado e pronto para uso.</span><span class="sxs-lookup"><span data-stu-id="fc362-149">If they match, the bot marks the token as validated and ready for use.</span></span> <span data-ttu-id="fc362-150">Caso contrário, o fluxo de auth falhará e o bot excluirá o token provisório.</span><span class="sxs-lookup"><span data-stu-id="fc362-150">Otherwise, the auth flow fails, and the bot deletes the provisional token.</span></span>

    > [!NOTE]
    > <span data-ttu-id="fc362-151">Se você tiver problemas com a autenticação no celular, verifique se o SDK JavaScript está atualizado para a versão 1.4.1 ou posterior.</span><span class="sxs-lookup"><span data-stu-id="fc362-151">If you experience issues with authentication on mobile, ensure your JavaScript SDK is updated to version 1.4.1 or later.</span></span>

## <a name="code-sample"></a><span data-ttu-id="fc362-152">Exemplo de código</span><span class="sxs-lookup"><span data-stu-id="fc362-152">Code sample</span></span>

<span data-ttu-id="fc362-153">Código de exemplo mostrando o processo de autenticação de bot:</span><span class="sxs-lookup"><span data-stu-id="fc362-153">Sample code showing the bot authentication process:</span></span>

| <span data-ttu-id="fc362-154">**Exemplo de nome**</span><span class="sxs-lookup"><span data-stu-id="fc362-154">**Sample name**</span></span> | <span data-ttu-id="fc362-155">**Descrição**</span><span class="sxs-lookup"><span data-stu-id="fc362-155">**Description**</span></span> | <span data-ttu-id="fc362-156">**Node.js**</span><span class="sxs-lookup"><span data-stu-id="fc362-156">**Node.js**</span></span> | <span data-ttu-id="fc362-157">**.NET**</span><span class="sxs-lookup"><span data-stu-id="fc362-157">**.NET**</span></span> | <span data-ttu-id="fc362-158">**Python**</span><span class="sxs-lookup"><span data-stu-id="fc362-158">**Python**</span></span> |
|-----------------|----------------|--------------|----------|-----------|
| <span data-ttu-id="fc362-159">Teams autenticação</span><span class="sxs-lookup"><span data-stu-id="fc362-159">Teams authentication</span></span> | <span data-ttu-id="fc362-160">Este exemplo demonstra autenticação em Microsoft Teams aplicativos.</span><span class="sxs-lookup"><span data-stu-id="fc362-160">This sample demonstrates authentication in Microsoft Teams apps.</span></span> | [<span data-ttu-id="fc362-161">View</span><span class="sxs-lookup"><span data-stu-id="fc362-161">View</span></span>](https://github.com/OfficeDev/microsoft-teams-sample-auth-node) | | |
| <span data-ttu-id="fc362-162">Autenticação bot</span><span class="sxs-lookup"><span data-stu-id="fc362-162">Bot authentication</span></span> | <span data-ttu-id="fc362-163">Este exemplo de demonio começa a usar a autenticação para um processo de Microsoft Teams</span><span class="sxs-lookup"><span data-stu-id="fc362-163">This sample demonstartes how to use authentication for a bot runnning in Microsoft Teams</span></span> | [<span data-ttu-id="fc362-164">View</span><span class="sxs-lookup"><span data-stu-id="fc362-164">View</span></span>](https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/javascript_nodejs/46.teams-auth) | [<span data-ttu-id="fc362-165">View</span><span class="sxs-lookup"><span data-stu-id="fc362-165">View</span></span>](https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/csharp_dotnetcore/46.teams-auth) | [<span data-ttu-id="fc362-166">View</span><span class="sxs-lookup"><span data-stu-id="fc362-166">View</span></span>](https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/python/46.teams-auth)

## <a name="see-also"></a><span data-ttu-id="fc362-167">Confira também</span><span class="sxs-lookup"><span data-stu-id="fc362-167">See also</span></span>

[<span data-ttu-id="fc362-168">Adicionar autenticação ao seu Teams bot</span><span class="sxs-lookup"><span data-stu-id="fc362-168">Add authentication to your Teams bot</span></span>](add-authentication.md)
