---
title: Microsoft Teams Fluxo de autenticação para bots
description: Descreve fluxo de autenticação Microsoft Teams em bots
keywords: robôs de fluxo de autenticação de equipes
localization_priority: Normal
ms.topic: overview
ms.openlocfilehash: f3bf73c105dc38e1cea515bfa7bb7d5324b02ce4
ms.sourcegitcommit: 51e4a1464ea58c254ad6bd0317aca03ebf6bf1f6
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 05/19/2021
ms.locfileid: "52565897"
---
# <a name="authentication-flow-for-bots-in-microsoft-teams"></a><span data-ttu-id="0aba4-104">Fluxo de autenticação para bots em Microsoft Teams</span><span class="sxs-lookup"><span data-stu-id="0aba4-104">Authentication flow for bots in Microsoft Teams</span></span>

<span data-ttu-id="0aba4-105">O OAuth 2.0 é um padrão aberto para autenticação e autorização usadas pelo Azure Active Directory (Azure AD) e muitos outros provedores de identidade.</span><span class="sxs-lookup"><span data-stu-id="0aba4-105">OAuth 2.0 is an open standard for authentication and authorization used by Azure Active Directory (Azure AD) and many other identity providers.</span></span> <span data-ttu-id="0aba4-106">Um entendimento básico do OAuth 2.0 é um pré-requisito para trabalhar com autenticação em Teams; [aqui está uma boa visão geral](https://aaronparecki.com/oauth-2-simplified/) que é mais fácil de seguir do que a [especificação formal](https://oauth.net/2/).</span><span class="sxs-lookup"><span data-stu-id="0aba4-106">A basic understanding of OAuth 2.0 is a prerequisite for working with authentication in Teams; [here's a good overview](https://aaronparecki.com/oauth-2-simplified/) that's easier to follow than the [formal specification](https://oauth.net/2/).</span></span> <span data-ttu-id="0aba4-107">O fluxo de autenticação para guias e bots é um pouco diferente — as guias são muito semelhantes aos sites para que eles possam usar o OAuth 2.0 diretamente, enquanto os bots não são e devem fazer algumas coisas de forma diferente — mas os conceitos principais são idênticos.</span><span class="sxs-lookup"><span data-stu-id="0aba4-107">Authentication flow for tabs and bots is a little different — tabs are very similar to websites so they can use OAuth 2.0 directly, while bots aren't and must do a few things differently — but the core concepts are identical.</span></span>

<span data-ttu-id="0aba4-108">Consulte a amostra de [autenticação Microsoft Teams](https://github.com/OfficeDev/Microsoft-Teams-Samples/tree/main/samples/app-auth/nodejs) GitHub repo para um exemplo que demonstra o fluxo de autenticação para bots que usam Node.js e o [tipo de concessão de código de autorização OAuth 2.0](https://oauth.net/2/grant-types/authorization-code/).</span><span class="sxs-lookup"><span data-stu-id="0aba4-108">See the GitHub repo [Microsoft Teams Authentication Sample](https://github.com/OfficeDev/Microsoft-Teams-Samples/tree/main/samples/app-auth/nodejs) for an example that demonstrates authentication flow for bots using Node.js and the [OAuth 2.0 authorization code grant type](https://oauth.net/2/grant-types/authorization-code/).</span></span>

![Diagrama da sequência de autenticação de bot](../../../assets/images/authentication/bot_auth_sequence_diagram.png)

1. <span data-ttu-id="0aba4-110">O usuário envia uma mensagem para o bot.</span><span class="sxs-lookup"><span data-stu-id="0aba4-110">The user sends a message to the bot.</span></span>
2. <span data-ttu-id="0aba4-111">O bot determina se o usuário precisa fazer login.</span><span class="sxs-lookup"><span data-stu-id="0aba4-111">The bot determines if the user needs to sign in.</span></span>
   <span data-ttu-id="0aba4-112">Neste exemplo, o bot armazena o token de acesso em sua loja de dados de usuário.</span><span class="sxs-lookup"><span data-stu-id="0aba4-112">In this example, the bot stores the access token in its user data store.</span></span> <span data-ttu-id="0aba4-113">Ele pede ao usuário para fazer login se ele não tiver um token validado para o provedor de identidade selecionado.</span><span class="sxs-lookup"><span data-stu-id="0aba4-113">It asks the user to sign in if it doesn't have a validated token for the selected identity provider.</span></span> <span data-ttu-id="0aba4-114">(Ver[código)](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76)</span><span class="sxs-lookup"><span data-stu-id="0aba4-114">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76))</span></span>
3. <span data-ttu-id="0aba4-115">O bot constrói a URL para a página inicial do fluxo de autenticação e envia um cartão para o usuário com uma `signin` ação.</span><span class="sxs-lookup"><span data-stu-id="0aba4-115">The bot constructs the URL to the start page of the authentication flow, and sends a card to the user with a `signin` action.</span></span> <span data-ttu-id="0aba4-116">(Ver[código)](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190)</span><span class="sxs-lookup"><span data-stu-id="0aba4-116">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190))</span></span></br>
    <span data-ttu-id="0aba4-117">Como outros fluxos de auth de aplicativos em Teams, a página inicial deve estar em um domínio que está em sua `validDomains` lista e no mesmo domínio da página de redirecionamento pós-login.</span><span class="sxs-lookup"><span data-stu-id="0aba4-117">Like other application auth flows in Teams, the start page must be in a domain that's on your `validDomains` list, and in the same domain as the post-login redirect page.</span></span>
    > [!IMPORTANT] 
    > <span data-ttu-id="0aba4-118">O fluxo de concessão de código de autorização OAuth 2.0 exige um `state` parâmetro na solicitação de autenticação que contém um token de sessão exclusivo para evitar um ataque de [falsificação de solicitação entre sites](https://en.wikipedia.org/wiki/Cross-site_request_forgery).</span><span class="sxs-lookup"><span data-stu-id="0aba4-118">The OAuth 2.0 authorization code grant flow calls for a `state` parameter in the authentication request which contains a unique session token to prevent a [cross-site request forgery attack](https://en.wikipedia.org/wiki/Cross-site_request_forgery).</span></span> <span data-ttu-id="0aba4-119">O exemplo usa um GUID gerado aleatoriamente.</span><span class="sxs-lookup"><span data-stu-id="0aba4-119">The example uses a randomly-generated GUID.</span></span>
4. <span data-ttu-id="0aba4-120">Quando o usuário seleciona o botão *de sinalização,* Teams abre uma janela pop-up e navega até a página inicial.</span><span class="sxs-lookup"><span data-stu-id="0aba4-120">When the user selects the *signin* button, Teams opens a popup window and navigates to the start page.</span></span>
   > [!NOTE]
   > <span data-ttu-id="0aba4-121">O tamanho da janela pop-up pode ser controlado através de parâmetros de sequência de espartidão de largura e altura na URL.</span><span class="sxs-lookup"><span data-stu-id="0aba4-121">The size of the pop-up window can be controlled through width and height query string parameters in the URL.</span></span> <span data-ttu-id="0aba4-122">Por exemplo, se você adicionar largura=500 e altura=500, o tamanho da janela pop-up é de 500x500 pixels.</span><span class="sxs-lookup"><span data-stu-id="0aba4-122">For example, if you add width=500 and height=500, the size of the pop-up window is 500x500 pixels.</span></span> <span data-ttu-id="0aba4-123">Teams exibe a janela pop-up com o tamanho dado do pixel, até um máximo que é uma porcentagem do tamanho da janela principal.</span><span class="sxs-lookup"><span data-stu-id="0aba4-123">Teams displays the pop-up window with the given pixel size, up to a maximum that's a percentage of the size of the main window.</span></span>

5. <span data-ttu-id="0aba4-124">A página inicial redireciona o usuário para o ponto final do provedor de `authorize` identidade.</span><span class="sxs-lookup"><span data-stu-id="0aba4-124">The start page redirects the user to the identity provider's `authorize` endpoint.</span></span> <span data-ttu-id="0aba4-125">(Ver[código)](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56)</span><span class="sxs-lookup"><span data-stu-id="0aba4-125">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56))</span></span>
6. <span data-ttu-id="0aba4-126">No site do provedor, o usuário faz a assinatura e concede acesso ao bot.</span><span class="sxs-lookup"><span data-stu-id="0aba4-126">On the provider's site, the user signs in and grants access to the bot.</span></span>
7. <span data-ttu-id="0aba4-127">O provedor leva o usuário para a página de redirecionamento OAuth do bot com um código de autorização.</span><span class="sxs-lookup"><span data-stu-id="0aba4-127">The provider takes the user to the bot's OAuth redirect page with an authorization code.</span></span>
8. <span data-ttu-id="0aba4-128">O bot resgata o código de autorização para um token de acesso e associa **provisoriamente** o token ao usuário que iniciou o fluxo de login.</span><span class="sxs-lookup"><span data-stu-id="0aba4-128">The bot redeems the authorization code for an access token, and **provisionally** associates the token with the user that initiated the sign-in flow.</span></span> <span data-ttu-id="0aba4-129">Abaixo, chamamos isso de *um token provisório.*</span><span class="sxs-lookup"><span data-stu-id="0aba4-129">Below, we call this a *provisional token*.</span></span>
    * <span data-ttu-id="0aba4-130">No exemplo, o bot associa o valor do `state` parâmetro com o ID do usuário que iniciou o processo de login para que ele possa depois igualá-lo com o valor devolvido pelo provedor de `state` identidade.</span><span class="sxs-lookup"><span data-stu-id="0aba4-130">In the example, the bot associates the value of the `state` parameter with the ID of the user that initiated the sign-in process so it can later match it with the `state` value returned by the identity provider.</span></span> <span data-ttu-id="0aba4-131">(Ver[código)](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99)</span><span class="sxs-lookup"><span data-stu-id="0aba4-131">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99))</span></span>
      > [!IMPORTANT] 
      > <span data-ttu-id="0aba4-132">O bot armazena o token que recebe do provedor de identidade e o associa a um usuário específico, mas é marcado como "validação pendente".</span><span class="sxs-lookup"><span data-stu-id="0aba4-132">The bot stores the token it receives from the identity provider and associates it with a specific user, but it is marked as "pending validation".</span></span> 
    * <span data-ttu-id="0aba4-133">O token provisório não pode ser usado sem maiores validações.</span><span class="sxs-lookup"><span data-stu-id="0aba4-133">The provisional token can't be used without further validation.</span></span>
      1. <span data-ttu-id="0aba4-134">**Validar o que é recebido do provedor de identidade.**</span><span class="sxs-lookup"><span data-stu-id="0aba4-134">**Validate what's received from the identity provider.**</span></span> <span data-ttu-id="0aba4-135">O valor do `state` parâmetro deve ser confirmado em relação ao que foi salvo anteriormente.</span><span class="sxs-lookup"><span data-stu-id="0aba4-135">The value of the `state` parameter must be confirmed against what was saved earlier.</span></span> 
      1. <span data-ttu-id="0aba4-136">**Valide o que é recebido de Teams.**</span><span class="sxs-lookup"><span data-stu-id="0aba4-136">**Validate what's received from Teams.**</span></span> <span data-ttu-id="0aba4-137">Uma [validação de autenticação em duas etapas](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) é realizada para garantir que o usuário que autorizou o bot com o provedor de identidade seja o mesmo usuário que está conversando com o bot.</span><span class="sxs-lookup"><span data-stu-id="0aba4-137">A [two-step authentication](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) validation is performed to ensure that the user who authorized the bot with the identity provider is the same user who is chatting with the bot.</span></span> <span data-ttu-id="0aba4-138">Este guarda contra [ataques de homem no meio](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) e [phishing.](https://en.wikipedia.org/wiki/Phishing)</span><span class="sxs-lookup"><span data-stu-id="0aba4-138">This guards against [man-in-the-middle](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) and [phishing](https://en.wikipedia.org/wiki/Phishing) attacks.</span></span> <span data-ttu-id="0aba4-139">O bot gera um código de verificação e o armazena, associado ao usuário.</span><span class="sxs-lookup"><span data-stu-id="0aba4-139">The bot generates a verification code and stores it, associated with the user.</span></span> <span data-ttu-id="0aba4-140">O código de verificação é enviado automaticamente por Teams conforme descrito abaixo.</span><span class="sxs-lookup"><span data-stu-id="0aba4-140">The verification code is sent automatically by Teams as described below.</span></span> <span data-ttu-id="0aba4-141">(Ver[código)](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113)</span><span class="sxs-lookup"><span data-stu-id="0aba4-141">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113))</span></span>
9. <span data-ttu-id="0aba4-142">O retorno de chamada do OAuth renderiza uma página que chama `notifySuccess("<verification code>")` .</span><span class="sxs-lookup"><span data-stu-id="0aba4-142">The OAuth callback renders a page that calls `notifySuccess("<verification code>")`.</span></span> <span data-ttu-id="0aba4-143">(Ver[código)](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs)</span><span class="sxs-lookup"><span data-stu-id="0aba4-143">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs))</span></span>
10. <span data-ttu-id="0aba4-144">Teams fecha a janela pop-up e envia o `<verification code>` enviado de volta para o `notifySuccess()` bot.</span><span class="sxs-lookup"><span data-stu-id="0aba4-144">Teams closes the pop-up window and sends the `<verification code>` sent to `notifySuccess()` back to the bot.</span></span> <span data-ttu-id="0aba4-145">O bot recebe uma mensagem [de invocação](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) com `name = signin/verifyState` .</span><span class="sxs-lookup"><span data-stu-id="0aba4-145">The bot receives an [invoke](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) message with `name = signin/verifyState`.</span></span>
11. <span data-ttu-id="0aba4-146">O bot verifica o código de verificação recebido em relação ao código de verificação armazenado com o token provisório do usuário.</span><span class="sxs-lookup"><span data-stu-id="0aba4-146">The bot checks the incoming verification code against the verification code stored with the user's provisional token.</span></span> <span data-ttu-id="0aba4-147">(Ver[código)](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140)</span><span class="sxs-lookup"><span data-stu-id="0aba4-147">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140))</span></span>
12. <span data-ttu-id="0aba4-148">Se eles corresponderem, o bot marca o token como validado e pronto para uso.</span><span class="sxs-lookup"><span data-stu-id="0aba4-148">If they match, the bot marks the token as validated and ready for use.</span></span> <span data-ttu-id="0aba4-149">Caso contrário, o fluxo de auth falha e o bot exclui o token provisório.</span><span class="sxs-lookup"><span data-stu-id="0aba4-149">Otherwise, the auth flow fails, and the bot deletes the provisional token.</span></span>

    > [!NOTE]
    > <span data-ttu-id="0aba4-150">Se você tiver problemas com autenticação no celular, certifique-se de que seu JavaScript SDK seja atualizado para a versão 1.4.1 ou posterior.</span><span class="sxs-lookup"><span data-stu-id="0aba4-150">If you experience issues with authentication on mobile, ensure your JavaScript SDK is updated to version 1.4.1 or later.</span></span>

## <a name="code-sample"></a><span data-ttu-id="0aba4-151">Exemplo de código</span><span class="sxs-lookup"><span data-stu-id="0aba4-151">Code sample</span></span>

<span data-ttu-id="0aba4-152">Código de amostra mostrando o processo de autenticação do bot:</span><span class="sxs-lookup"><span data-stu-id="0aba4-152">Sample code showing the bot authentication process:</span></span>

| <span data-ttu-id="0aba4-153">**Nome da amostra**</span><span class="sxs-lookup"><span data-stu-id="0aba4-153">**Sample name**</span></span> | <span data-ttu-id="0aba4-154">**Descrição**</span><span class="sxs-lookup"><span data-stu-id="0aba4-154">**Description**</span></span> | <span data-ttu-id="0aba4-155">**Node.js**</span><span class="sxs-lookup"><span data-stu-id="0aba4-155">**Node.js**</span></span> | <span data-ttu-id="0aba4-156">**.NET**</span><span class="sxs-lookup"><span data-stu-id="0aba4-156">**.NET**</span></span> | <span data-ttu-id="0aba4-157">**Python**</span><span class="sxs-lookup"><span data-stu-id="0aba4-157">**Python**</span></span> |
|-----------------|----------------|--------------|----------|-----------|
| <span data-ttu-id="0aba4-158">autenticação Teams</span><span class="sxs-lookup"><span data-stu-id="0aba4-158">Teams authentication</span></span> | <span data-ttu-id="0aba4-159">Esta amostra demonstra autenticação em aplicativos Microsoft Teams.</span><span class="sxs-lookup"><span data-stu-id="0aba4-159">This sample demonstrates authentication in Microsoft Teams apps.</span></span> | [<span data-ttu-id="0aba4-160">View</span><span class="sxs-lookup"><span data-stu-id="0aba4-160">View</span></span>](https://github.com/OfficeDev/microsoft-teams-sample-auth-node) | | |
| <span data-ttu-id="0aba4-161">Autenticação de bot</span><span class="sxs-lookup"><span data-stu-id="0aba4-161">Bot authentication</span></span> | <span data-ttu-id="0aba4-162">Esta amostra demoniza como usar autenticação para um runnning de bot em Microsoft Teams</span><span class="sxs-lookup"><span data-stu-id="0aba4-162">This sample demonstartes how to use authentication for a bot runnning in Microsoft Teams</span></span> | [<span data-ttu-id="0aba4-163">View</span><span class="sxs-lookup"><span data-stu-id="0aba4-163">View</span></span>](https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/javascript_nodejs/46.teams-auth) | [<span data-ttu-id="0aba4-164">View</span><span class="sxs-lookup"><span data-stu-id="0aba4-164">View</span></span>](https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/csharp_dotnetcore/46.teams-auth) | [<span data-ttu-id="0aba4-165">View</span><span class="sxs-lookup"><span data-stu-id="0aba4-165">View</span></span>](https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/python/46.teams-auth)

## <a name="see-also"></a><span data-ttu-id="0aba4-166">Confira também</span><span class="sxs-lookup"><span data-stu-id="0aba4-166">See also</span></span>

[<span data-ttu-id="0aba4-167">Adicione autenticação ao seu bot Teams</span><span class="sxs-lookup"><span data-stu-id="0aba4-167">Add authentication to your Teams bot</span></span>](add-authentication.md)
