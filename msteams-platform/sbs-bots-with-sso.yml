### YamlMime:Tutorial
title: Teams Bot com logon único
metadata:
  title: Teams Bot com SSO
  description: 'Neste tutorial, você aprenderá a configurar o SSO em um bot para Teams.'
  audience: Developer
  level: Beginner
  ms.date: 08/24/2021
  ms.topic: interactive-tutorial
  nextTutorialHref: bots/how-to/authentication/auth-aad-sso-bots.md
  nextTutorialTitle: Leia mais sobre autenticação de bot
  ms.custom: mvc
  ms.localizationpriority: high
items:
  - durationInMinutes: 1
    content: |
      Teams bots são bots de conversa que executem tarefas automatizadas repetitivas realizadas pelos usuários, como o atendimento ao cliente. O usuário precisa entrar com suas credenciais várias vezes para executar tarefas repetitivas. O método de autenticação SSO (SSO) de Azure Active Directory atualiza silenciosamente o token de autenticação. Isso resulta na redução do número de vezes que os usuários precisam inserir suas credenciais de entrada. 

      Um bot se comporta de forma diferente, dependendo da conversa em que está envolvido:

      * Bots em conversas de chat de canal e grupo exigem que o usuário @mention o bot.
      * Bots em uma conversa privada não exigem uma @menção. Todas as mensagens enviadas pelo usuário são encaminhadas para o bot.

      Este guia passo a passo ajuda você a criar um bot com autenticação SSO habilitada. Você verá a seguinte saída:

      ![Mobile signed in to bot](~/assets/images/bots/sbs-desktop-mobile.png)
  - title: Pré-requisitos
    durationInMinutes: 1
    content: |
      Certifique-se de instalar as seguintes ferramentas e configurar seu ambiente de desenvolvimento:  

      * Conta Microsoft Teams conta ativa com imagem de perfil

        > [!TIP]
        > Verifique se Microsoft Teams conta não é uma conta de convidado.

      * [ngrok](https://ngrok.com/) ou solução de túnel equivalente

        > [!NOTE]
        > Depois de baixar o ngrok, inscreva-se e instale [authtoken](https://ngrok.com/download).

      * Visual Studio 2019 ou a versão mais recente
      * [Microsoft 365 conta de desenvolvedor](https://docs.microsoft.com/en-us/microsoftteams/platform/concepts/build-and-test/prepare-your-o365-tenant) ou acesso Teams conta com as permissões apropriadas para instalar um aplicativo
  - title: Configurar bot no Serviço de Bot do Azure
    durationInMinutes: 5
    content: |
      Para autenticar o bot com SSO, você pode configurar bot no Serviço de Bot do Azure. Registre bot com o Serviço de Bot do Azure quando você o desenvolver e hospedá-lo no Azure. Execute as etapas a seguir:

      * Use ngrok para criar um túnel para os pontos de extremidade do servidor Web.
      * Crie o recurso bot do Azure para registrar bot com o Serviço bot do Azure.
      * Crie o segredo do cliente que habilita a autenticação SSO do bot.
      * Adicione Microsoft Teams canal para implantar o bot em um canal Teams.
      * Adicione o ponto de extremidade de mensagens ao túnel de ngrok que você criou.

      Use o ngrok para criar um túnel para os pontos de extremidade HTTPS disponíveis publicamente do servidor Web em execução local. Execute o seguinte comando em ngrok:

      ```bash
      ngrok http -host-header=rewrite 3978
      ```

      **Para criar o recurso bot do Azure**

      1. Vá para o [portal Microsoft Azure.](https://portal.azure.com/)
      1. Selecione **Criar um recurso**.
      1. Na caixa de pesquisa, insira **o bot do Azure** e selecione a tecla Enter.
      1. Selecione **Bot do Azure**.

          ![Criar cartão de bot do Azure](~/assets/images/bots/createazurebot.png)

      1. Selecionar **Criar**.
      1. Insira o nome de alça de bot necessário no **alça bot**.
      1. Na lista **suspenso** Assinatura, selecione a assinatura.
      1. Na lista **listada de grupos** de recursos, selecione o grupo de recursos.
          
          Para criar um novo recurso, selecione **Criar novo**, insira nome do recurso, selecione **OK** e selecione o local necessário na lista suspenso **Novo** local do grupo de recursos.

          > [!NOTE]
          > Na seção ID do Aplicativo da Microsoft, **Criar nova ID do Microsoft App** já está selecionado. Você pode selecionar **Usar o registro de aplicativo existente**, inserir **id de aplicativo existente** e inserir **senha de aplicativo existente**.

      1. Selecione **Examinar + criar**.

          <img src="~/assets/images/bots/Azurebotcreate.png" alt="Create resource Azure bot" width="700"/>

      1. Se a validação for aprovada, selecione **Criar**.

          Leva alguns instantes para que o serviço de bot seja provisionado.

      1. Selecione **Acessar recursos**. O bot e os recursos relacionados estão listados no grupo de recursos.

          Agora seu bot do Azure foi criado.

          ![Recurso de bot do Azure criado](~/assets/images/bots/Azurebotresource.png)

      **Para criar o segredo do cliente**

      1. Em **Configurações**, selecione **Configuração**.

         > [!TIP]
         > Salve a **ID do Microsoft App** ou **a ID do Cliente** para referência futura.

      1. Selecione **MultiTenant** em **Tipo de Bot**.

           ![Tipo de bot](~/assets/images/bots/bot-type.png)

      1. Ao lado da **ID do Microsoft App**, selecione **Gerenciar**.

           ![ID do Aplicativo Microsoft](~/assets/images/bots/MicrosoftAppID.png)

      1. Na seção **Segredos do** cliente, selecione **Novo segredo do cliente**. A **janela Adicionar um segredo do** cliente é exibida.  

      1. Insira **Descrição** e selecione **Adicionar**.

          <img src="~/assets/images/bots/addclientsecret.png" alt="Add client secret to app" width="500"/>

      1. Na coluna **Valor** , selecione **Copiar para área de transferência** e salve a ID do segredo do cliente para referência futura.

           ![Valor do segredo do cliente](~/assets/images/bots/valueclientsecret.png)
         
      **Para adicionar o Microsoft Teams canal**

      1. Vá para **Home**.

          <img src="~/assets/images/bots/homepage.png" alt="Home page" width="600"/>

      1. Abra seu bot, que está listado na **seção Recursos recentes** .
      1. Selecione **Canais** no painel esquerdo e selecione **Teams** <img src="~/assets/images/bots/teamsicon.png" alt="Teams icon" width="20"/>.    
            ![Abrir Teams canais](~/assets/images/bots/channel-teams.png)    
            ![Selecione Teams](~/assets/images/bots/select-teams.png)    
      1. Selecione **Salvar**.
      1. Selecione a caixa de seleção para aceitar os termos de serviço e selecione **Concordar**.</br>
            ![Termos de serviço](~/assets/images/bots/select-terms-of-service.png)

      **Para adicionar ponto de extremidade de mensagens**

      1. Em **Configurações** para o bot do Azure que você criou, selecione **Configuração**.
      1. Vá para ngrok.
      1. Copie a URL HTTPS (https para io) conforme mostrado na imagem a seguir:

          ![URL HTTPS do ngrok](~/assets/images/bots/ngrokURL.png)

      1. No **ponto de extremidade mensagens**, use a URL HTTPS disponível no ngrok e, no final da URL, adicione **/api/messages**.

          <img src="~/assets/images/bots/messagingURL.png" alt="Messaging endpoint" width="600"/>

      1. Selecione **Aplicar**.

          Você definiu com êxito um bot no Serviço de Bot do Azure e agora precisa configurar a conexão de serviço bot.
  - title: Configurar o SSO para seu bot
    durationInMinutes: 5
    content: |
      Para garantir que o Serviço bot permita que o usuário entre e acesse o bot, você deve configurar o SSO para seu bot. Para fazer isso, execute as seguintes etapas:

      * Adicione o URI de redirecionamento ao recurso de bot do Azure.
      * Exponha o ponto de extremidade da API para especificar o local de onde os recursos podem ser acessados.
      * Autorizar aplicativos cliente.
      * Adicione quaisquer permissões de API necessárias para chamadas a jusante.
      * Habilitar concessão implícita.
      * Atualizar manifesto.
      * Configurar a conexão de Serviço bot.

      **Para adicionar o URI de redirecionamento ao recurso de bot do Azure**

      1. Adjacente à **ID do Microsoft App**, selecione **Gerenciar**.</br>
          ![Gerenciar a ID do aplicativo](~/assets/images/bots/select-manage.png)
      1. No painel esquerdo do recurso bot, selecione **Autenticação**.
      1. Em **Configurações de plataforma**, selecione **Adicionar uma plataforma**.
      1. Selecione **Web**.

      1. Insira **URIs de redirecionamento** como **https://token.botframework.com/.auth/web/redirect** e selecione **Configurar**.

          <img src="~/assets/images/bots/redirectURI.png" alt="Configure Redirect URI" width="600"/>

          O URI de redirecionamento é adicionado ao recurso de bot do Azure.

          ![URI de redirecionamento adicionado ao recurso bot](~/assets/images/bots/redirectURIadded.png)

      **Para expor o ponto de extremidade da API**

      1. No painel esquerdo, selecione **Expor uma API**.
      1. Selecione **Definir** para o URI de ID do Aplicativo.
      1. Use o URI de ID do aplicativo mostrado e api://botid **-** no início do URI.

          <img src="~/assets/images/bots/exposeAPI.png" alt="Expose an API" width="500"/>

      1. Selecione **Salvar**. Salve o **URI de ID do Aplicativo** para referência futura.
      1. Selecione **Adicionar um escopo**.
      1. Em **Nome do escopo**, **digite access_as_user**.
      1. Em **Who pode consentir?**, alternar para **Administradores e usuários**.
      1. Insira os seguintes valores nas caixas:

          | Campo | Valor |
          | ----- | ----- |
          | Nome de exibição de consentimento do administrador | Teams pode acessar o perfil do usuário |
          | Descrição do consentimento do administrador | Permite Teams chamar as APIs web do aplicativo como o usuário atual. |
          | Nome de exibição de consentimento do usuário | Teams pode acessar seu perfil de usuário e fazer solicitações em seu nome |
          | Descrição do consentimento do usuário | Habilita Teams chamar as APIs desse aplicativo com os mesmos direitos que você tem. |

      1. Verifique se o **Estado** está definido como **Habilitado**.

          <img src="~/assets/images/bots/addscope.png" alt="Add a scope to app" width="500"/>

      1. Selecione **Adicionar escopo**. O nome do escopo corresponde automaticamente ao URI de ID do aplicativo, com **/access_as_user** adicionado ao final.

          ![API exposta e escopo adicionado](~/assets/images/bots/ExposeAPIandaddscope.png)

      **Para autorizar aplicativos cliente**

      Adicione as seguintes IDs como **aplicativos cliente autorizados** e selecione também a caixa de seleção para **escopos autorizados**:      
      * 1fec8e78-bce4-4aaf-ab1b-5451cc387264 (Teams aplicativo móvel ou desktop)            
      * 5e3ce6c0-2b1f-4285-8d4b-75ee78787346 (Teams aplicativo Web)</br>     
          ![Adicionar aplicativo cliente ao aplicativo](~/assets/images/bots/addclientapplication1.png)        

      **Para adicionar quaisquer permissões de API necessárias para chamadas downstream**

      1. Selecione **permissões de API** no painel esquerdo.
      1. Adicione qualquer permissão delegada pelo usuário que seu aplicativo exija para APIs de downstream, por exemplo, User.Read.</br>
          ![Permissões de usuário da API](~/assets/images/bots/APIpermissions.png)

      **Para habilitar a concessão implícita**

      1. Selecione **Autenticação** no painel esquerdo.
      1. Selecione as **caixas de seleção Tokens de** **Acesso e tokens de ID** .</br>
          ![Caixas de seleção de autenticação para o aplicativo](~/assets/images/bots/authenticationcheckboxes.png)
      1. Selecione **Salvar** para salvar as alterações.

      **Para atualizar manifesto**

      1. Selecione **Manifesto** no painel esquerdo.
      1. Verifique se o item config está definido como **"accessTokenAcceptedVersion": 2**. Caso não seja, altere seu valor para **2** e selecione **Salvar**. (Se você já estiver testando seu bot no Teams, deverá assinar este aplicativo e Teams. Em seguida, entre novamente para ver essa alteração).</br>
          ![Manifesto de atualização](~/assets/images/bots/update-manifest.png)</br>

      **Para configurar a conexão de Serviço de Bot**

      1. Vá para **Página de configuraçãoAdd** >  **OAuth Connection Configurações**.
      1. Selecione **Adicionar conexão OAuth Configurações**.
      1. Em **Nova Configuração de Conexão**, insira os seguintes detalhes:

          | Campo | Valor ou descrição |
          | ----- | ----- |
          | Nome | Digite o nome da nova configuração de conexão. Você pode usar o nome nas configurações do código de serviço de bot. |
          | Service Provider | Selecione **Azure Active Directory V2**. |
          | ID do cliente | Salvo anteriormente como sua **ID do Microsoft App**. |
          | Segredo do cliente | Salvo anteriormente **como Valor** da ID secreta do cliente. |
          | URL Exchange token | Use a **URL de ID do Aplicativo** obtida anteriormente durante a exposição do ponto de extremidade da API. |
          | ID do locatário | Insira **comum**. |
          | Scopes | Insira **User.Read e** também adicione todos os **Escopos necessários** ao especificar permissões para APIs de downstream. |

          <img src="~/assets/images/bots/botserviceconnection.png" alt="Bot Service connection" width="300"/>

      1. Selecione **Salvar**.
      1. Selecione **Aplicar**.
  - title: Configurar e executar seu exemplo de bot
    durationInMinutes: 1
    content: |
      Configure o exemplo de bot para entender como autenticar o bot de conversa no Microsoft Teams.

      **Para configurar e executar seu exemplo de bot**

      1. Abra o Visual Studio.
      1. Em Visual Studio, selecione **Clonar um repositório**.
      1. No local **repositório**, digite **https://github.com/OfficeDev/Microsoft-Teams-Samples.git**. Certifique-se de observar **o Caminho** em que o repositório é clonado.
      1. Selecione **Arquivo > Abrir > Project/Solução**.
      1. Vá para **Microsoft-Teams-Samples > exemplos > pasta bot-conversation-sso-quickstart > csharp_dotnetcore**.
      1. Abra o **arquivo BotSSOCSharp.csproj** .
      1. Abra o **arquivo appsettings.json** .
      1. Atualize **a configuração appsettings.json** para o bot usar e `MicrosoftAppId` `MicrosoftAppPassword`. Use o nome da conexão OAuth como o **Nome da Conexão**.

          > [!NOTE]
          > Você pode obter a `MicrosoftAppId` partir da página Configuração do bot. The `MicrosoftAppPassword` is the Value for client secret ID that you saved previously.

          ![Appsettings json](~/assets/images/bots/appsettingsjson.png)

      1. Selecione a **tecla F5** para executar este projeto.

          <br>

          <details>

          <summary><b>Solução de Problemas</b></summary>

          Se você obter o **erro Não é possível encontrar o** pacote, siga estas etapas:

          1.  Vá para **Ferramentas** >  **NuGet Gerenciador de Pacotes** >  **Gerenciador de Pacotes Configurações**.
          1.  Na janela **Opções** exibida, **selecione NuGet Gerenciador de Pacotes** >  **Package Sources**.
          1.  Selecione **Adicionar**.
          1.  Em **Nome**, insira **nuget.org** e, em **Source**, insira **https://api.nuget.org/v3/index.json**.
          1.  Selecione **Atualizar** e **OK**.
          1.  Reconstruir seu projeto.
          <br>

          </details>
  - title: Configurar e executar o Teams aplicativo
    durationInMinutes: 2
    content: |
      A maneira mais abrangente de testar seu bot é criando um pacote de aplicativos e carregando-o para Teams. Este método é a única maneira de testar a funcionalidade completa disponível para o bot, em todos os escopos. Você pode configurar e executar o aplicativo Teams carregando o arquivo **manifest.zip**.

      **Para executar o Teams, carregando o arquivo manifest.zip**

      1. Em Visual Studio, vá para **a pasta appPackage/**.
      1. Abra o **arquivo manifest.json** .
      1. No arquivo **manifest.json** , encontre **{TODO: MicrosoftAppId}** e substitua-o por sua ID do Microsoft App.
      1. No Windows Explorer, vá para **a pasta Microsoft-Teams-Samples > exemplos > bot-conversation-sso-quickstart > csharp_dotnetcore > appPackage**.
      1. Feche o conteúdo do **appPackage/** pasta **para criarmanifest.zip**.
      1. Vá para Teams.
      1. Para carregar **manifest.zip**, selecione **Armazenar > Gerenciar seus aplicativos > Upload um aplicativo** personalizado e abra **manifest.zip**.
      1. Selecione **Adicionar** para adicionar o bot de conversa ao chat.

          Você pode interagir com esse bot enviando uma mensagem. O Bot troca um token SSO e faz uma chamada para a API Graph em seu nome e retorna os resultados. Ele mantém você entrar, a menos que você envie uma mensagem para **logout**.

      1. Envie uma mensagem para o bot. O bot de conversa solicita permissões pela primeira vez.

          ![Permissões para bot](~/assets/images/bots/sbsdesktop-mobile-consent-request.png)

      1. Selecione **Continuar** para aceitar as permissões.

      1. Selecione **Aceitar** **permissões solicitadas**.

          ![Mobile signed in to bot](~/assets/images/bots/sbs-desktop-mobile.png)
  - title: Desafio completo
    durationInMinutes: 1
    content: |
      Você achou algo assim?

      ![Mobile signed in to bot](~/assets/images/bots/sbs-desktop-mobile.png)
  - content: |
      Você concluiu o tutorial para começar com o SSO em um bot para Microsoft Teams usando a Estrutura de Bot.