---
title: Fluxo de autenticação para bots
description: Descreve o fluxo de autenticação em bots
keywords: bots de fluxo de autenticação de equipes
ms.date: 03/01/2018
ms.openlocfilehash: 5230a94b23f9042d9d7753b52467fba5b2fec89e
ms.sourcegitcommit: 4329a94918263c85d6c65ff401f571556b80307b
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 02/01/2020
ms.locfileid: "41672947"
---
# <a name="microsoft-teams-authentication-flow-for-bots"></a><span data-ttu-id="787a1-104">Fluxo de autenticação do Microsoft Teams para bots</span><span class="sxs-lookup"><span data-stu-id="787a1-104">Microsoft Teams authentication flow for bots</span></span>

[!include[v3-to-v4-SDK-pointer](~/includes/v3-to-v4-pointer-bots.md)]

<span data-ttu-id="787a1-105">O OAuth 2,0 é um padrão aberto para autenticação e autorização usados pelo Azure AD e muitos outros provedores de identidade.</span><span class="sxs-lookup"><span data-stu-id="787a1-105">OAuth 2.0 is an open standard for authentication and authorization used by Azure AD and many other identity providers.</span></span> <span data-ttu-id="787a1-106">Uma compreensão básica do OAuth 2,0 é um pré-requisito para trabalhar com autenticação no Microsoft Teams; [Veja aqui uma boa visão geral](https://aaronparecki.com/oauth-2-simplified/) que é mais fácil de seguir do que a [especificação formal](https://oauth.net/2/).</span><span class="sxs-lookup"><span data-stu-id="787a1-106">A basic understanding of OAuth 2.0 is a prerequisite for working with authentication in Teams; [here's a good overview](https://aaronparecki.com/oauth-2-simplified/) that's easier to follow than the [formal specification](https://oauth.net/2/).</span></span> <span data-ttu-id="787a1-107">O fluxo de autenticação para guias e bots é um pouco diferente porque guias são muito semelhantes aos sites para que eles possam usar o OAuth 2,0 diretamente, e os bots não são e devem fazer algumas coisas de forma diferente, mas os conceitos principais são idênticos.</span><span class="sxs-lookup"><span data-stu-id="787a1-107">Authentication flow for tabs and bots are a little different because tabs are very similar to websites so they can use OAuth 2.0 directly, and bots are not and must do a few things differently, but the core concepts are identical.</span></span>

<span data-ttu-id="787a1-108">Confira o [exemplo de autenticação do Microsoft Teams](https://github.com/OfficeDev/microsoft-teams-sample-auth-node) do GitHub para obter um exemplo que demonstre o fluxo de autenticação para bots usando o nó usando o [tipo de concessão de código de autorização OAuth 2,0](https://oauth.net/2/grant-types/authorization-code/).</span><span class="sxs-lookup"><span data-stu-id="787a1-108">See the GitHub repo [Microsoft Teams Authentication Sample](https://github.com/OfficeDev/microsoft-teams-sample-auth-node) for an example that demonstrates authentication flow for bots using Node using the [OAuth 2.0 authorization code grant type](https://oauth.net/2/grant-types/authorization-code/).</span></span>

![Diagrama de sequência de autenticação de bot](~/assets/images/authentication/bot_auth_sequence_diagram.png)

1. <span data-ttu-id="787a1-110">O usuário envia uma mensagem para o bot.</span><span class="sxs-lookup"><span data-stu-id="787a1-110">The user sends a message to the bot.</span></span>
2. <span data-ttu-id="787a1-111">O bot determina se o usuário precisa entrar.</span><span class="sxs-lookup"><span data-stu-id="787a1-111">The bot determines if the user needs to sign in.</span></span>
    * <span data-ttu-id="787a1-112">Neste exemplo, o bot armazena o token de acesso no armazenamento de dados do usuário.</span><span class="sxs-lookup"><span data-stu-id="787a1-112">In this example, the bot stores the access token in its user data store.</span></span> <span data-ttu-id="787a1-113">Ele solicita que o usuário faça logon se não tiver um token validado para o provedor de identidade selecionado.</span><span class="sxs-lookup"><span data-stu-id="787a1-113">It asks the user to log in if it doesn't have a validated token for the selected identity provider.</span></span> <span data-ttu-id="787a1-114">([Exibir código](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76))</span><span class="sxs-lookup"><span data-stu-id="787a1-114">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76))</span></span>
3. <span data-ttu-id="787a1-115">O bot cria a URL para a página inicial do fluxo de autenticação e envia um cartão para o usuário com uma `signin` ação.</span><span class="sxs-lookup"><span data-stu-id="787a1-115">The bot constructs the URL to the start page of the authentication flow, and sends a card to the user with a `signin` action.</span></span> <span data-ttu-id="787a1-116">([Exibir código](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190))</span><span class="sxs-lookup"><span data-stu-id="787a1-116">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190))</span></span>
    * <span data-ttu-id="787a1-117">Como outros fluxos de autenticação de aplicativos no Microsoft Teams, a página inicial deve estar em um domínio `validDomains` que esteja na sua lista e no mesmo domínio que a página de redirecionamento pós-logon.</span><span class="sxs-lookup"><span data-stu-id="787a1-117">Like other application auth flows in Teams, the start page must be on a domain that's in your `validDomains` list, and on the same domain as the post-login redirect page.</span></span>
    * <span data-ttu-id="787a1-118">**Importante**: o fluxo de concessão do código de autorização OAuth 2,0 `state` chama um parâmetro na solicitação de autenticação que contém um token de sessão exclusivo para evitar um [ataque de falsificação de solicitação entre sites](https://en.wikipedia.org/wiki/Cross-site_request_forgery).</span><span class="sxs-lookup"><span data-stu-id="787a1-118">**IMPORTANT**: The OAuth 2.0 authorization code grant flow calls for a `state` parameter in the authentication request which contains a unique session token to prevent a [cross-site request forgery attack](https://en.wikipedia.org/wiki/Cross-site_request_forgery).</span></span> <span data-ttu-id="787a1-119">O exemplo usa um GUID gerado aleatoriamente.</span><span class="sxs-lookup"><span data-stu-id="787a1-119">The example uses a randomly-generated GUID.</span></span>
4. <span data-ttu-id="787a1-120">Quando o usuário clica no botão de *entrada* , o Microsoft Teams abre uma janela pop-up e a navega para a página inicial.</span><span class="sxs-lookup"><span data-stu-id="787a1-120">When the user clicks on the *signin* button, Teams opens a popup window and navigates it to the start page.</span></span>
5. <span data-ttu-id="787a1-121">A página inicial redireciona o usuário para o ponto de extremidade do `authorize` provedor de identidade.</span><span class="sxs-lookup"><span data-stu-id="787a1-121">The start page redirects the user to the identity provider's `authorize` endpoint.</span></span> <span data-ttu-id="787a1-122">([Exibir código](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56))</span><span class="sxs-lookup"><span data-stu-id="787a1-122">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56))</span></span>
6. <span data-ttu-id="787a1-123">No site do provedor, o usuário entra e concede acesso ao bot.</span><span class="sxs-lookup"><span data-stu-id="787a1-123">On the provider's site, the user signs in and grants access to the bot.</span></span>
7. <span data-ttu-id="787a1-124">O provedor leva o usuário para a página de redirecionamento OAuth do bot, com um código de autorização.</span><span class="sxs-lookup"><span data-stu-id="787a1-124">The provider takes the user to the bot's OAuth redirect page, with an authorization code.</span></span>
8. <span data-ttu-id="787a1-125">O bot reconsidera o código de autorização para um token de acesso e **associa o** token ao usuário que iniciou o fluxo de entrada.</span><span class="sxs-lookup"><span data-stu-id="787a1-125">The bot redeems the authorization code for an access token, and **provisionally** associates the token with the user that initiated the sign-in flow.</span></span> <span data-ttu-id="787a1-126">A seguir, chamamos isso de um *token provisório*.</span><span class="sxs-lookup"><span data-stu-id="787a1-126">Below, we call this a *provisional token*.</span></span>
    * <span data-ttu-id="787a1-127">No exemplo, o bot associa o valor do `state` parâmetro com a ID do usuário que iniciou o processo de entrada para que ele possa correspondê-lo mais tarde com o `state` valor retornado pelo provedor de identidade.</span><span class="sxs-lookup"><span data-stu-id="787a1-127">In the example, the bot associates the value of the `state` parameter with the id of the user that initiated the sign-in process so it can later match it with the `state` value returned by the identity provider.</span></span> <span data-ttu-id="787a1-128">([Exibir código](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99))</span><span class="sxs-lookup"><span data-stu-id="787a1-128">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99))</span></span>
    * <span data-ttu-id="787a1-129">**Importante**: o bot armazena o token que recebe do provedor de identidade e o associa a um usuário específico, mas está marcado como "validação pendente".</span><span class="sxs-lookup"><span data-stu-id="787a1-129">**IMPORTANT**: The bot stores the token it receives from the identity provider and associates it with a specific user, but it is marked as "pending validation".</span></span> <span data-ttu-id="787a1-130">O token provisório ainda não pode ser usado: ele deve ser validado novamente:</span><span class="sxs-lookup"><span data-stu-id="787a1-130">The provisional token cannot be used yet: it must be further validated:</span></span> 
      1. <span data-ttu-id="787a1-131">**Validar o que é recebido do provedor de identidade.**</span><span class="sxs-lookup"><span data-stu-id="787a1-131">**Validate what's received from the identity provider.**</span></span> <span data-ttu-id="787a1-132">O valor do `state` parâmetro deve ser confirmado em relação ao que foi salvo anteriormente.</span><span class="sxs-lookup"><span data-stu-id="787a1-132">The value of the `state` parameter must be confirmed against what was saved earlier.</span></span> 
      1. <span data-ttu-id="787a1-133">**Validar o que é recebido do teams.**</span><span class="sxs-lookup"><span data-stu-id="787a1-133">**Validate what's received from Teams.**</span></span> <span data-ttu-id="787a1-134">Uma validação de [autenticação de duas etapas](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) é executada para garantir que o usuário que autorizou o bot com o provedor de identidade seja o mesmo usuário que está batendo papo com o bot.</span><span class="sxs-lookup"><span data-stu-id="787a1-134">A [two-step authentication](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) validation is performed to ensure that the user who authorized the bot with the identity provider is the same user who is chatting with the bot.</span></span> <span data-ttu-id="787a1-135">Isso protege contra ataques [Man-in-the-Middle](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) e [phishing](https://en.wikipedia.org/wiki/Phishing) .</span><span class="sxs-lookup"><span data-stu-id="787a1-135">This guards against [man-in-the-middle](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) and [phishing](https://en.wikipedia.org/wiki/Phishing) attacks.</span></span> <span data-ttu-id="787a1-136">O bot gera um código de verificação e o armazena, associado ao usuário.</span><span class="sxs-lookup"><span data-stu-id="787a1-136">The bot generates a verification code and stores it, associated with the user.</span></span> <span data-ttu-id="787a1-137">O código de verificação é enviado automaticamente pelo Teams, conforme descrito abaixo nas etapas 9 e 10.</span><span class="sxs-lookup"><span data-stu-id="787a1-137">The verification code is sent automatically by Teams as described below in steps 9 and 10.</span></span> <span data-ttu-id="787a1-138">([Exibir código](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113))</span><span class="sxs-lookup"><span data-stu-id="787a1-138">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113))</span></span>
9. <span data-ttu-id="787a1-139">O retorno de chamada OAuth renderiza uma página que `notifySuccess("<verification code>")`chama.</span><span class="sxs-lookup"><span data-stu-id="787a1-139">The OAuth callback renders a page that calls `notifySuccess("<verification code>")`.</span></span> <span data-ttu-id="787a1-140">([Exibir código](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs))</span><span class="sxs-lookup"><span data-stu-id="787a1-140">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs))</span></span>
10. <span data-ttu-id="787a1-141">O Microsoft Teams fecha o pop `<verification code>` -up `notifySuccess()` e envia o enviado para de volta para o bot.</span><span class="sxs-lookup"><span data-stu-id="787a1-141">Teams closes the popup and sends the `<verification code>` sent to `notifySuccess()` back to the bot.</span></span> <span data-ttu-id="787a1-142">O bot recebe uma mensagem [Invoke](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) com `name = signin/verifyState`.</span><span class="sxs-lookup"><span data-stu-id="787a1-142">The bot receives an [invoke](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) message with `name = signin/verifyState`.</span></span>
11. <span data-ttu-id="787a1-143">O bot verifica o código de verificação de entrada em relação ao código de verificação armazenado com o token provisório do usuário.</span><span class="sxs-lookup"><span data-stu-id="787a1-143">The bot checks the incoming verification code against the verification code stored with the user's provisional token.</span></span> <span data-ttu-id="787a1-144">([Exibir código](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140))</span><span class="sxs-lookup"><span data-stu-id="787a1-144">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140))</span></span>
12. <span data-ttu-id="787a1-145">Se houver correspondência, o bot marca o token como validado e pronto para uso.</span><span class="sxs-lookup"><span data-stu-id="787a1-145">If they match, the bot marks the token as validated and ready for use.</span></span> <span data-ttu-id="787a1-146">Caso contrário, o fluxo de autenticação falhará e o bot excluirá o token provisionado.</span><span class="sxs-lookup"><span data-stu-id="787a1-146">Otherwise, the auth flow fails, and the bot deletes the provisional token.</span></span>

> [!Note]
> <span data-ttu-id="787a1-147">Se você tiver problemas com a autenticação em dispositivos móveis, verifique se o SDK do JavaScript está atualizado para a versão 1.4.1 ou posterior.</span><span class="sxs-lookup"><span data-stu-id="787a1-147">If you experience issues with authentication on mobile, ensure your Javascript SDK is update to version 1.4.1 or later.</span></span>

## <a name="samples"></a><span data-ttu-id="787a1-148">Exemplos</span><span class="sxs-lookup"><span data-stu-id="787a1-148">Samples</span></span>

<span data-ttu-id="787a1-149">Para ver o código de exemplo que mostra o processo de autenticação do bot, confira:</span><span class="sxs-lookup"><span data-stu-id="787a1-149">For sample code showing the bot authentication process see:</span></span>

* [<span data-ttu-id="787a1-150">Exemplo de autenticação de bot do Microsoft Teams (nó)</span><span class="sxs-lookup"><span data-stu-id="787a1-150">Microsoft Teams bot authentication sample (Node)</span></span>](https://github.com/OfficeDev/microsoft-teams-sample-auth-node)

## <a name="more-details"></a><span data-ttu-id="787a1-151">Mais detalhes</span><span class="sxs-lookup"><span data-stu-id="787a1-151">More details</span></span>

<span data-ttu-id="787a1-152">Para obter instruções detalhadas de implementação para a autenticação de bot direcionada ao Azure Active Directory, confira:</span><span class="sxs-lookup"><span data-stu-id="787a1-152">For detailed implementation walkthroughs for bot authentication targeting Azure Active Directory see:</span></span>

* [<span data-ttu-id="787a1-153">Autenticar um usuário em um bot do Microsoft Teams</span><span class="sxs-lookup"><span data-stu-id="787a1-153">Authenticate a user in a Microsoft Teams bot</span></span>](~/resources/bot-v3/bot-authentication/auth-bot-AAD.md)
